<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Forum</title>
    <link rel="stylesheet" href="css/common.css" />
    <link rel="stylesheet" href="css/discussion.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="topbar">
      <a href="/project/" class="icon-button">
        <img src="images/icon.png" alt="Icon" width="64px" height="64px" />
      </a>
      <a href="/project/" class="topbar-button">Home</a>
      <a href="course-catalog.html" class="topbar-button">Course Catalog</a>
      <a href="progress.html" class="topbar-button">Progress Tracker</a>
      <a href="forum.html" class="topbar-button">Community</a>
      <a href="dashboard.html" class="topbar-button">Dashboard</a>
      <div class="nav-right">
        <a href="login.html" class="btn-outline">Log in</a>
        <a href="signup.html" class="btn-primary">Sign up</a>
      </div>
    </div>
    <div class="forum-header">
      <div class="header-content">
        <h1 class="title-lg">Forum</h1>
        <button class="submit">Post</button><br />
      </div>
    </div>

    <div class="container">
      <div id="posts-container"></div>
    </div>

    <!-- Post Modal -->
    <div id="postModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Create a New Post</h2>
          <span class="modal-close">&times;</span>
        </div>
        <form id="postForm" class="modal-form">
          <div class="form-group">
            <label for="postTitle">Title</label>
            <input
              type="text"
              id="postTitle"
              placeholder="Enter post title"
              required
            />
          </div>
          <div class="form-group">
            <label for="postContent">Content</label>
            <textarea
              id="postContent"
              placeholder="Enter your post content"
              rows="5"
              required
            ></textarea>
          </div>
          <div class="form-group">
            <label for="postAuthor">Author Name</label>
            <input
              type="text"
              id="postAuthor"
              placeholder="Your name"
              required
            />
          </div>
          <div class="modal-footer">
            <button type="button" class="modal-cancel">Cancel</button>
            <button type="submit" class="modal-submit">Post</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const STORAGE_KEY_COMMENTS = "forumComments";
      const STORAGE_KEY_POSTS = "forumPosts";

      // List of swear words to filter
      const SWEAR_WORDS = [
        "damn",
        "hell",
        "crap",
        "shit",
        "fuck",
        "ass",
        "bitch",
        "bastard",
        "piss",
        "dick",
        "cock",
        "pussy",
        "asshole",
        "bullshit",
        "motherfucker",
        "fck",
        "wtf",
        "stfu",
        "babi",
        "pukimak",
      ];

      function containsSwearWords(text) {
        const lowerText = text.toLowerCase();
        return SWEAR_WORDS.some((word) => {
          const regex = new RegExp(`\\b${word}\\b`, "i");
          return regex.test(lowerText);
        });
      }

      function getMatchedSwearWords(text) {
        const lowerText = text.toLowerCase();
        return SWEAR_WORDS.filter((word) => {
          const regex = new RegExp(`\\b${word}\\b`, "i");
          return regex.test(lowerText);
        });
      }

      function openPostModal() {
        document.getElementById("postModal").style.display = "block";
      }

      function closePostModal() {
        document.getElementById("postModal").style.display = "none";
        document.getElementById("postForm").reset();
      }

      async function loadPosts() {
        const storedPosts = getStoredPosts();
        try {
          const response = await fetch("forum-posts.json");
          if (!response.ok) throw new Error("Network response was not ok");
          const data = await response.json();
          const dataPosts = Array.isArray(data.posts) ? data.posts : [];
          const allPosts = [...storedPosts, ...dataPosts];
          allPosts.sort((a, b) => b.id - a.id);
          renderPosts(allPosts);
        } catch (error) {
          console.error("Error loading posts:", error);
          // Fallback: render stored posts if available, otherwise show message
          if (storedPosts.length) {
            renderPosts(storedPosts);
          } else {
            const container = document.getElementById("posts-container");
            if (container)
              container.innerHTML =
                '<p class="text-muted">No posts available.</p>';
          }
        }
      }

      // Get stored posts from localStorage
      function getStoredPosts() {
        const stored = localStorage.getItem(STORAGE_KEY_POSTS);
        return stored ? JSON.parse(stored) : [];
      }

      // Save new post to localStorage
      function savePost(post) {
        const storedPosts = getStoredPosts();
        storedPosts.push(post);
        localStorage.setItem(STORAGE_KEY_POSTS, JSON.stringify(storedPosts));
      }

      // Get comments from localStorage for a post
      function getPostComments(postId) {
        const allComments = JSON.parse(
          localStorage.getItem(STORAGE_KEY_COMMENTS) || "{}"
        );
        return allComments[postId] || [];
      }

      // Save comment to localStorage
      function saveComment(postId, comment) {
        const allComments = JSON.parse(
          localStorage.getItem(STORAGE_KEY_COMMENTS) || "{}"
        );
        if (!allComments[postId]) {
          allComments[postId] = [];
        }
        allComments[postId].push(comment);
        localStorage.setItem(STORAGE_KEY_COMMENTS, JSON.stringify(allComments));
      }

      // Render posts to the DOM
      function renderPosts(posts) {
        const container = document.getElementById("posts-container");
        container.innerHTML = posts
          .map((post) => {
            const storedComments = getPostComments(post.id);
            const allComments = [...(post.comments || []), ...storedComments];
            return `
          <div class="post" data-post-id="${post.id}">
            <div class="post-header">
              <div class="post-profile">
                <img
                  src="images/profile-picture.png"
                  alt="Profile"
                  height="32"
                  width="32"
                />
              </div>
              <div class="post-info">
                <h2 class="post-title">
                  <strong>${post.title}</strong>
                </h2>
                <p class="post-author">- ${post.author} - ${post.timeAgo}</p>
              </div>
            </div>
            <div class="post-content">
              <p>${post.content}</p>
            </div>
            <div class="post-actions">
              <button class="vote-btn upvote" data-vote="up">
                <img
                  width="12"
                  height="12"
                  src="https://img.icons8.com/metro/26/long-arrow-up.png"
                  alt="upvote"
                />
                <span class="vote-count">${post.upvotes}</span>
              </button>
              <button class="vote-btn downvote" data-vote="down">
                <img
                  width="12"
                  height="12"
                  src="https://img.icons8.com/metro/26/long-arrow-down.png"
                  alt="downvote"
                />
                <span class="vote-count">${post.downvotes}</span>
              </button>
            </div>
            
            <div class="comments-section">
              <div class="comments-list">
                ${allComments
                  .map(
                    (comment) => `
                  <div class="comment">
                    <div class="comment-header">
                      <strong>${comment.author}</strong>
                      <span class="comment-time">- ${comment.timeAgo}</span>
                    </div>
                    <p class="comment-text">${comment.content}</p>
                  </div>
                `
                  )
                  .join("")}
              </div>
              
              <form class="comment-form" data-post-id="${post.id}">
                <input
                  type="text"
                  class="comment-input"
                  placeholder="Add a comment..."
                  required
                />
                <button type="submit" class="comment-btn">Comment</button>
              </form>
            </div>
            </div>
          </div>
        `;
          })
          .join("");

        // Re-attach vote button listeners
        attachVoteListeners();
        // Attach comment form listeners
        attachCommentListeners();
      }

      // Attach click listeners to vote buttons
      function attachVoteListeners() {
        const voteButtons = document.querySelectorAll(".vote-btn");

        voteButtons.forEach((button) => {
          button.addEventListener("click", function (e) {
            e.preventDefault();

            const isUpvote = this.classList.contains("upvote");
            const voteCount = this.querySelector(".vote-count");
            let currentCount = parseInt(voteCount.textContent);

            // Get the opposite button
            const oppositeButton = isUpvote
              ? this.parentElement.querySelector(".downvote")
              : this.parentElement.querySelector(".upvote");
            const oppositeCount = oppositeButton.querySelector(".vote-count");
            let oppositeValue = parseInt(oppositeCount.textContent);

            // Toggle current button
            if (this.classList.contains("active")) {
              // Deactivate
              this.classList.remove("active");
              currentCount--;
            } else {
              // Activate current
              this.classList.add("active");
              currentCount++;

              // Remove opposite active state
              if (oppositeButton.classList.contains("active")) {
                oppositeButton.classList.remove("active");
                oppositeValue--;
                oppositeCount.textContent = oppositeValue;
              }
            }

            voteCount.textContent = currentCount;
          });
        });
      }

      // Attach comment form listeners
      function attachCommentListeners() {
        const commentForms = document.querySelectorAll(".comment-form");

        commentForms.forEach((form) => {
          form.addEventListener("submit", function (e) {
            e.preventDefault();

            const postId = parseInt(this.getAttribute("data-post-id"));
            const input = this.querySelector(".comment-input");
            const commentText = input.value.trim();

            if (commentText) {
              // Validate for swear words
              if (containsSwearWords(commentText)) {
                const matchedWords = getMatchedSwearWords(commentText);
                alert(
                  `Your comment contains inappropriate language: "${matchedWords.join(
                    '", "'
                  )}". Please keep the discussion respectful.`
                );
                return;
              }

              const newComment = {
                author: "You",
                timeAgo: "just now",
                content: commentText,
              };

              saveComment(postId, newComment);
              input.value = "";

              // Reload posts to show new comment
              loadPosts();
            }
          });
        });
      }

      // Load posts when page loads
      loadPosts();

      // Modal event listeners
      const postBtn = document.querySelector(".submit");
      const postModal = document.getElementById("postModal");
      const modalClose = document.querySelector(".modal-close");
      const modalCancel = document.querySelector(".modal-cancel");
      const postForm = document.getElementById("postForm");

      if (postBtn) postBtn.addEventListener("click", openPostModal);

      if (modalClose) modalClose.addEventListener("click", closePostModal);
      if (modalCancel) modalCancel.addEventListener("click", closePostModal);

      window.addEventListener("click", function (event) {
        if (event.target === postModal) {
          closePostModal();
        }
      });

      if (postForm) {
        postForm.addEventListener("submit", function (e) {
          e.preventDefault();

          const titleEl = document.getElementById("postTitle");
          const contentEl = document.getElementById("postContent");
          const authorEl = document.getElementById("postAuthor");

          const title = titleEl ? titleEl.value.trim() : "";
          const content = contentEl ? contentEl.value.trim() : "";
          const author = authorEl ? authorEl.value.trim() : "Anonymous";

          if (!title || !content) {
            // Simple validation
            alert("Please provide both a title and content for your post.");
            return;
          }

          // Validate title for swear words
          if (containsSwearWords(title)) {
            const matchedWords = getMatchedSwearWords(title);
            alert(
              `Your post title contains inappropriate language: "${matchedWords.join(
                '", "'
              )}". Please use respectful language.`
            );
            return;
          }

          // Validate content for swear words
          if (containsSwearWords(content)) {
            const matchedWords = getMatchedSwearWords(content);
            alert(
              `Your post content contains inappropriate language: "${matchedWords.join(
                '", "'
              )}". Please use respectful language.`
            );
            return;
          }

          if (containsSwearWords(author)) {
            const matchedWords = getMatchedSwearWords(author);
            alert(
              `Your author name contains inappropriate language: "${matchedWords.join(
                '", "'
              )}". Please use a respectful name.`
            );
            return;
          }

          const newPost = {
            id: Date.now(),
            title: title,
            author: author,
            timeAgo: "just now",
            content: content,
            upvotes: 0,
            downvotes: 0,
            comments: [],
          };

          savePost(newPost);
          closePostModal();
          loadPosts();
        });
      }
    </script>

    <footer class="footer">
      <div class="footer-content">
        <div class="footer-section">
          <h4>About</h4>
          <p>
            Learn to build the web with interactive lessons designed for
            real-world skills.
          </p>
        </div>

        <div class="footer-section">
          <h4>Quick Links</h4>
          <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="course-catalog.html">Course Catalog</a></li>
            <li><a href="progress.html">Progress Tracker</a></li>
            <li><a href="forum.html">Community</a></li>
          </ul>
        </div>

        <div class="footer-section">
          <h4>Resources</h4>
          <ul>
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="login.html">Login</a></li>
            <li><a href="signup.html">Sign Up</a></li>
          </ul>
        </div>

        <div class="footer-section">
          <h4>Connect With Us</h4>
          <div class="social-links">
            <a href="#" aria-label="Facebook"
              ><i class="fa-brands fa-facebook"></i
            ></a>
            <a href="#" aria-label="Twitter"
              ><i class="fa-brands fa-twitter"></i
            ></a>
            <a href="#" aria-label="LinkedIn"
              ><i class="fa-brands fa-linkedin"></i
            ></a>
            <a href="#" aria-label="GitHub"
              ><i class="fa-brands fa-github"></i
            ></a>
          </div>
        </div>
      </div>

      <div class="footer-bottom">
        <p>
          &copy; 2026 Web Fundamentals Learning Platform. All rights reserved.
        </p>
      </div>
    </footer>
  </body>
</html>
